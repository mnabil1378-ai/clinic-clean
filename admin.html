<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; direction: rtl; padding: 20px; background-color: #f9f9f9; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #007bff; color: white; }
    button { margin: 2px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
    .edit-btn { background-color: #ffc107; color: white; }
    .delete-btn { background-color: #dc3545; color: white; }
    .print-btn { background-color: #28a745; color: white; }
    .whatsapp-btn { background-color: #25d366; color: white; }
  </style>
</head>
<body>

  <h2>ğŸ“‹ Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h2>

  <!-- ğŸ” ÙÙ„ØªØ±Ø© Ø§Ù„Ø¨Ø­Ø« -->
  <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„ØªØ§Ø±ÙŠØ®..." oninput="filterTable()" style="margin: 10px; padding: 8px; width: 300px;">

  <table id="bookings-table">
    <thead>
      <tr>
        <th>ğŸ‘¶ Ø§Ù„Ø§Ø³Ù…</th>
        <th>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</th>
        <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>â° Ø§Ù„ÙˆÙ‚Øª</th>
        <th>ğŸ’° Ø§Ù„Ø³Ø¹Ø±</th>
        <th>ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th>
        <th>âœï¸ ØªØ¹Ø¯ÙŠÙ„</th>
        <th>ğŸ—‘ï¸ Ø­Ø°Ù</th>
        <th>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</th>
        <th>ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
// âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
fetch('/patient-visits/all')
  .then(res => res.json())
  .then(data => {
    const tbody = document.querySelector('#bookings-table tbody');
    data.forEach(entry => {
      const nameMatch = entry.match(/ğŸ‘¶ Ø§Ù„Ø§Ø³Ù…: (.*)/);
      const phoneMatch = entry.match(/ğŸ“ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ: (.*)/);
      const dateMatch = entry.match(/ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø²: (.*)/);
      const timeMatch = entry.match(/â° Ø§Ù„ÙˆÙ‚Øª: (.*)/);
      const priceMatch = entry.match(/ğŸ’° Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒØ´Ù: (.*)/);
      const noteMatch = entry.match(/ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨: ?(.*)?/);

      const name = nameMatch ? nameMatch[1] : '';
      const phone = phoneMatch ? phoneMatch[1] : '';
      const date = dateMatch ? dateMatch[1] : '';
      const time = timeMatch ? timeMatch[1] : '';
      const price = priceMatch ? priceMatch[1] : '';
      const note = noteMatch ? noteMatch[1] : '';

      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${name}</td>
        <td>${phone}</td>
        <td>${date}</td>
        <td>${time}</td>
        <td>${price}</td>
        <td>${note || 'â€”'}</td>
        <td><button class="edit-btn" onclick="editRow(this)">ØªØ¹Ø¯ÙŠÙ„</button></td>
        <td><button class="delete-btn" onclick="deleteRow(this)">Ø­Ø°Ù</button></td>
        <td><button class="print-btn" onclick="printRow(this)">Ø·Ø¨Ø§Ø¹Ø©</button></td>
        <td><button class="whatsapp-btn" onclick="sendWhatsApp(this)">ÙˆØ§ØªØ³Ø§Ø¨</button></td>
      `;
      tbody.appendChild(row);
    });
  });

function editRow(btn) {
  const row = btn.parentElement.parentElement;
  const tds = row.querySelectorAll('td');
  const oldPhone = tds[1].innerText;
  const oldDate = tds[2].innerText;

  const newName = prompt("Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯", tds[0].innerText);
  const newPhone = prompt("Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯", tds[1].innerText);
  const newDate = prompt("ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯", tds[2].innerText);
  const newTime = prompt("Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯", tds[3].innerText);

  fetch('/edit-booking', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ oldPhone, oldDate, newName, newPhone, newDate, newTime })
  })
  .then(res => res.text())
  .then(msg => {
    alert(msg);
    location.reload();
  });
}

function deleteRow(btn) {
  const row = btn.parentElement.parentElement;
  const phone = row.children[1].innerText;
  const date = row.children[2].innerText;

  if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) {
    fetch('/delete-booking', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ phone, date })
    })
    .then(res => res.text())
    .then(msg => {
      alert(msg);
      location.reload();
    });
  }
}

function printRow(btn) {
  const row = btn.parentElement.parentElement;
  const cells = row.querySelectorAll('td');
  const content = `
    <h2>Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø­Ø¬Ø²</h2>
    <p>ğŸ‘¶ Ø§Ù„Ø§Ø³Ù…: ${cells[0].innerText}</p>
    <p>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${cells[1].innerText}</p>
    <p>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${cells[2].innerText}</p>
    <p>â° Ø§Ù„ÙˆÙ‚Øª: ${cells[3].innerText}</p>
    <p>ğŸ’° Ø§Ù„Ø³Ø¹Ø±: ${cells[4].innerText}</p>
  `;
  const printWin = window.open('', '', 'width=600,height=400');
  printWin.document.write(content);
  printWin.print();
  printWin.close();
}

function sendWhatsApp(btn) {
  const row = btn.parentElement.parentElement;
  const name = row.children[0].innerText;
  const phone = row.children[1].innerText;
  const date = row.children[2].innerText;
  const time = row.children[3].innerText;

  const message = `Ù…Ø±Ø­Ø¨Ù‹Ø§ ${name}%0aØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø²Ùƒ Ø¨ØªØ§Ø±ÙŠØ® ${date} ÙÙŠ ØªÙ…Ø§Ù… ${time}.%0aÙ†Ø±Ø§Ùƒ Ø¹Ù„Ù‰ Ø®ÙŠØ± Ø¥Ù† Ø´Ø§Ø¡ Ø§Ù„Ù„Ù‡.`;
  const url = `https://wa.me/2${phone}?text=${message}`;
  window.open(url, '_blank');
}

function filterTable() {
  const input = document.getElementById("searchInput").value.trim().toLowerCase();
  const rows = document.querySelectorAll("#bookings-table tbody tr");

  rows.forEach(row => {
    const text = row.innerText.replace(/\s+/g, ' ').toLowerCase();
    row.style.display = text.includes(input) ? '' : 'none';
  });
}
</script>

</body>
</html>
