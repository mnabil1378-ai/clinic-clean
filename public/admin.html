<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css">
  <style>
    body { direction: rtl; padding: 20px; background-color: #f8f9fa; }
    .dark-mode { background-color: #1e1e1e !important; color: white; }
    .dark-mode table { color: white; }
    .form-section { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
    .dark-mode .form-section { background: #2c2c2c; }
    table { background-color: white; }
    .dark-mode table { background-color: #333; }
    .form-control, .btn { margin-bottom: 10px; }
  </style>
</head>
<body id="body">

  <div class="container">
    <h1 class="text-center mb-4">ğŸ¥ Ø¹ÙŠØ§Ø¯Ø© Ø¯. Ù‡Ø¨Ø© ØµÙ„Ø§Ø­</h1>

    <h2 class="mb-4">ğŸ“‹ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h2>
<button id="toggle-dark-mode" class="btn btn-dark mb-3">ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</button>

    <div class="form-section">
      <h4>â• Ø­Ø¬Ø² Ø¬Ø¯ÙŠØ¯</h4>
      <form id="new-booking-form">
        <input type="text" id="name" class="form-control" placeholder="ğŸ‘¶ Ø§Ù„Ø§Ø³Ù…" required>
        <input type="tel" id="phone" class="form-control" placeholder="ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ" required>
        <input type="date" id="date" class="form-control" required>
        <input type="time" id="time" class="form-control" required>
        <button type="submit" class="btn btn-success">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø²</button>
      </form>
    </div>

    <div class="form-section">
      <h4>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª</h4>
      <input type="text" id="search-stats" class="form-control" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...">
      <p class="mt-2">ğŸ“… Ø§Ù„ÙŠÙˆÙ…: <span id="today-count">0</span> | ğŸ“ˆ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: <span id="week-count">0</span> | ğŸ—“ï¸ Ø§Ù„Ø´Ù‡Ø±: <span id="month-count">0</span></p>
      ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: <span id="total-revenue">0</span> Ø¬Ù†ÙŠÙ‡
    </div>

    <div class="form-section">
      <input type="text" id="search" class="form-control" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ...">
      <table class="table table-bordered table-striped mt-3">
        <thead>
  <tr>
    <th>#</th>
    <th>ğŸ‘¶ Ø§Ù„Ø§Ø³Ù…</th>
    <th>ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ</th>
    <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
    <th>â° Ø§Ù„ÙˆÙ‚Øª</th>
    <th>ğŸ“ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©</th> <!-- âœ… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
    <th>ğŸ“¥ Ù†Ø³Ø®</th>
    <th>âœï¸ ØªØ¹Ø¯ÙŠÙ„</th>
    <th>ğŸ—‘ï¸ Ø­Ø°Ù</th>
    <th>ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</th>
    <th>ğŸ“± ÙˆØ§ØªØ³Ø§Ø¨</th>
  </tr>
</thead>

        <tbody id="bookings-table"></tbody>
      </table>
    </div>
  </div>

<script>
let allBookings = [];
let editingBooking = null;
const serverURL = "https://3e13698f-ffcf-4213-81d5-8e9c9aeb5dbf-00-3iqirian9zu63.janeway.replit.dev";

function renderTable(data) {
  const table = document.getElementById("bookings-table");
  table.innerHTML = "";
  data.forEach((booking, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${booking.name}</td>
      <td>${booking.phone}</td>
      <td>${booking.date}</td>
      <td>${booking.time}</td>
      <td>
        <input type="text" class="form-control form-control-sm" value="${booking.note || ""}" 
        onchange="saveNote('${booking.phone}', '${booking.date}', this.value)">
      </td>
      <td><button class="btn btn-secondary btn-sm" onclick='copyToForm(${JSON.stringify(booking)})'>ğŸ“¥</button></td>
      <td><button class="btn btn-warning btn-sm" onclick='editBooking(${JSON.stringify(booking)})'>âœï¸</button></td>
      <td><button class="btn btn-danger btn-sm" onclick='deleteBooking("${booking.phone}", "${booking.date}")'>ğŸ—‘ï¸</button></td>
      <td><button class="btn btn-info btn-sm" onclick='printBooking(${JSON.stringify(booking)})'>ğŸ–¨ï¸</button></td>
      <td>
        <a class="btn btn-success btn-sm" target="_blank"
        href="https://wa.me/+2${booking.phone}?text=Ù…Ø±Ø­Ø¨Ù‹Ø§ ${booking.name}ØŒ ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¬Ø²Ùƒ Ø¨ØªØ§Ø±ÙŠØ® ${booking.date} Ø§Ù„Ø³Ø§Ø¹Ø© ${booking.time}. Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¹Ø±ÙˆØ¨Ø© Ø§Ù„Ø·Ø¨ÙŠ - Ø£Ù…Ø§Ù… Ù…Ø³Ø¬Ø¯ Ø®Ø§Ù„Ø¯ Ø¨Ù† Ø§Ù„ÙˆÙ„ÙŠØ¯">
        ğŸ“±</a>
      </td>
    `;
    table.appendChild(row);
  });
}

function copyToForm(booking) {
  document.getElementById("name").value = booking.name;
  document.getElementById("phone").value = booking.phone;
  document.getElementById("date").value = booking.date;
  document.getElementById("time").value = booking.time;
}

function editBooking(booking) {
  editingBooking = booking;
  copyToForm(booking);
  document.querySelector('#toggle-dark-mode')?.scrollIntoView({ behavior: 'smooth' });
}

function deleteBooking(phone, date, callback) {
  fetch(`${serverURL}/delete-booking`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone, date })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      fetchData();
      if (callback) callback();
    } else {
      alert("ÙØ´Ù„ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø­Ø¬Ø²");
    }
  });
}

function saveNote(phone, date, note) {
  fetch(`${serverURL}/update-note`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ phone, date, note })
  })
  .then(res => res.json())
  .then(data => {
    if (!data.success) alert("âŒ ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©");
  })
  .catch(() => alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"));
}

function printBooking(booking) {
  const content = `
    ğŸ‘¶ Ø§Ù„Ø§Ø³Ù…: ${booking.name}
    ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${booking.phone}
    ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${booking.date}
    â° Ø§Ù„ÙˆÙ‚Øª: ${booking.time}
    ğŸ’° Ù‚ÙŠÙ…Ø© Ø§Ù„ÙƒØ´Ù: ${booking.price || '150 Ø¬Ù†ÙŠÙ‡'}
    ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨: ${booking.note || 'â€”'}
  `;
  const win = window.open('', '', 'height=400,width=600');
  win.document.write(`<pre>${content}</pre>`);
  win.print();
  win.close();
}

function fetchData() {
  fetch(`${serverURL}/patient-visits/all`)
    .then(res => res.json())
    .then(data => {
      allBookings = data;
      renderTable(data);
      updateStats(data);
    });
}

function updateStats(data) {
  const today = new Date().toISOString().slice(0, 10);
  const now = new Date();
  const weekStart = new Date(now.setDate(now.getDate() - now.getDay())).toISOString().slice(0, 10);
  const month = new Date().toISOString().slice(0, 7);

  const todayCount = data.filter(b => b.date === today).length;
  const weekCount = data.filter(b => b.date >= weekStart).length;
  const monthCount = data.filter(b => b.date.startsWith(month)).length;

  document.getElementById("today-count").textContent = todayCount;
  document.getElementById("week-count").textContent = weekCount;
  document.getElementById("month-count").textContent = monthCount;
}

const searchInput = document.getElementById("search");
searchInput.addEventListener("input", function () {
  const term = this.value.trim();
  const filtered = allBookings.filter(b =>
    b.name.includes(term) || b.phone.includes(term)
  );
  renderTable(filtered);
});

const form = document.getElementById("new-booking-form");
form.addEventListener("submit", async function (e) {
  e.preventDefault();
  const booking = {
    name: document.getElementById("name").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    date: document.getElementById("date").value,
    time: document.getElementById("time").value
  };

  try {
    let response;
    if (editingBooking) {
      response = await fetch(`${serverURL}/update-booking`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ old: editingBooking, updated: booking })
      });
    } else {
      response = await fetch(`${serverURL}/submit-booking`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(booking)
      });
    }

    const result = await response.json();
    alert(result.message);
    if (result.success) {
      fetchData();
      form.reset();
      editingBooking = null;
    }

  } catch (error) {
    console.error("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±");
  }
});

function fetchRevenue() {
  fetch(`${serverURL}/total-revenue`)
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        document.getElementById("total-revenue").textContent = data.total;
      }
    })
    .catch(err => {
      console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:", err);
    });
}

const body = document.getElementById('body');
const toggleBtn = document.getElementById('toggle-dark-mode');

const savedMode = localStorage.getItem("dark-mode");
if (savedMode === "true") {
  body.classList.add("dark-mode");
  toggleBtn.textContent = "â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ";
}

toggleBtn.addEventListener("click", () => {
  body.classList.toggle("dark-mode");
  const isDark = body.classList.contains("dark-mode");
  toggleBtn.textContent = isDark ? "â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ" : "ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ";
  localStorage.setItem("dark-mode", isDark);
});

fetchData();
fetchRevenue();
</script>

</body>
</html>
